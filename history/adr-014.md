# ADR-014: Estratégia de Injeção de Proxy no Service Mesh – Sidecar vs Ambient Mesh

Data: 2025-07-16  
Status: Aceita  
Projeto: Plataforma de Integração Multicloud  
Cliente: Cliente XYZ (segmento financeiro)  
Autores: Equipe de Arquitetura Sensedia

## Contexto

Estamos evoluindo a arquitetura de integração do Cliente XYZ para um modelo baseado em microsserviços com requisitos de observabilidade, segurança zero-trust e controle de tráfego entre workloads.

A solução envolve o uso de Istio como Service Mesh, mas há uma decisão crítica sobre **como os proxies Envoy devem ser aplicados às aplicações**:

- A abordagem tradicional com **Sidecar Injection**, que adiciona um proxy por pod.
- A nova abordagem **Ambient Mesh**, que desacopla o proxy e utiliza dois planos separados (zTunnel e waypoint proxy), oferecendo uma alternativa mais leve e transparente.

## Decisão

Decidimos adotar **Istio Ambient Mesh** como padrão para novos workloads, mantendo Sidecar Injection apenas para workloads legadas e casos com requisitos específicos de observabilidade avançada ou mutual TLS com granularidade no pod.

## Alternativas consideradas

- **Sidecar Injection (tradicional):**
  - + Alta granularidade no controle e métricas por pod.
  - – Overhead de recursos por pod.
  - – Complexidade operacional na gestão de sidecars e troubleshooting.

- **Ambient Mesh:**
  - + Redução significativa no uso de CPU/memória.
  - + Facilidade de adoção e menor atrito com os times de desenvolvimento.
  - – Menor maturidade (em beta até 2024), pode exigir fallback em certos cenários.

- **Service Mesh alternativos (Linkerd, Kuma):**
  - – Menor adoção em produção em ambientes regulados.
  - – Menor integração com ferramentas CNCF que já fazem parte do stack do cliente.

## Justificativa

- A nova arquitetura tem como premissa reduzir o acoplamento entre desenvolvimento e infraestrutura. Ambient Mesh traz essa separação sem comprometer requisitos de segurança ou observabilidade básica.
- Os benchmarks indicam redução de até **40% no uso de CPU** e **30% na latência de startup** dos pods, segundo testes internos da Sensedia.
- Permitirá onboarding mais fácil de novos times na malha de serviços.
- A modularidade com zTunnel e waypoint possibilita ajustes finos conforme a evolução das necessidades.

## Consequências

- Ganho imediato em performance e redução de custo de infraestrutura.
- Necessidade de monitorar atualizações do Istio para garantir estabilidade do Ambient Mesh (atualmente GA desde v1.22).
- Workloads legadas precisarão de estratégia híbrida (manter sidecars onde Ambient não cobre 100%).

## Embasamento técnico

- [Istio Ambient Mesh Architecture](https://istio.io/latest/docs/ambient/)
- [Ambient Mesh GA announcement (Istio blog)](https://istio.io/latest/blog/2024/ambient-ga/)
- [Service Mesh Performance Benchmark 2024 (Solo.io)](https://www.solo.io/blog/service-mesh-performance-benchmark-2024/)
- [RFC 8739 – Mutual TLS for HTTP/2](https://datatracker.ietf.org/doc/html/rfc8739)
- Livro: “Zero Trust Networks”, Evan Gilman & Doug Barth (O’Reilly)

## ADRs relacionadas

- ADR-008: Adoção de Service Mesh com Istio
- ADR-011: Estratégia de autenticação e autorização baseada em SPIFFE/SPIRE
- ADR-013: Observabilidade distribuída com OpenTelemetry + Tempo

## Revisões futuras

Reavaliar após 6 meses ou após upgrade para Istio 1.25. Caso ocorram falhas em integração com gateways ou limitações de visibilidade em zTunnel, revisar estratégia híbrida.